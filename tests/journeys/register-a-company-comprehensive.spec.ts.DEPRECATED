import { test, expect } from '../../fixtures/base.fixture';
import { JourneyBuilder } from '../../helpers/JourneyBuilder';
import { JourneyStepBlocks } from '../../helpers/JourneyStepBlocks';
import { GovUKPatternBlocks } from '../../helpers/GovUKPatternBlocks';
import { TestDataFactory } from '../../helpers/TestDataFactory';

/**
 * Register a Company Journey - Comprehensive Block-Based Tests
 * Following test requirements from REVIEW_TEST_STRATEGY.md
 * 
 * Journey Flow:
 * 1. Start page (Before you start)
 * 2. Company name
 * 3. Registered office address
 * 4. Director details
 * 5. Shareholder details
 * 6. Contact details
 * 7. Check your answers
 * 8. Confirmation
 */
test.describe('Register a Company Journey - Comprehensive', () => {
  const JOURNEY_PATH = '/department-for-business-and-trade/register-a-company/apply';

  test.describe('Happy Path Tests', () => {
    
    test('should complete full company registration journey @smoke @journey', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      // Generate test data
      const companyData = {
        name: 'Acme Corporation Ltd'
      };

      const addressData = {
        line1: '123 Business Park',
        line2: 'Suite 100',
        city: 'London',
        county: 'Greater London',
        postcode: 'SW1A 1AA'
      };

      const directorData = {
        firstName: 'Sarah',
        lastName: 'Johnson',
        email: 'sarah.johnson@acmecorp.com',
        telephone: '02071234567'
      };

      const shareholderData = {
        firstName: 'John',
        lastName: 'Smith',
        shares: '100',
        shareValue: '1'
      };

      const contactData = {
        email: 'contact@acmecorp.com',
        name: 'Sarah Johnson'
      };

      await new JourneyBuilder(page, journeyRunner, componentHelper)
        // Start journey
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.verifyHeading('Before you start'))
        .addStep(JourneyStepBlocks.continue())
        
        // Company name
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': companyData.name }
        ))
        
        // Registered office address
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': addressData.line1,
            'Address line 2 (optional)': addressData.line2,
            'Town or city': addressData.city,
            'County (optional)': addressData.county,
            'Postcode': addressData.postcode
          }
        ))
        
        // Director details
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Director's details",
          {
            'First name': directorData.firstName,
            'Last name': directorData.lastName,
            'Email address': directorData.email,
            'Telephone number (optional)': directorData.telephone
          }
        ))
        
        // Shareholder details
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Shareholder's details",
          {
            'First name': shareholderData.firstName,
            'Last name': shareholderData.lastName,
            'Number of shares': shareholderData.shares,
            'Value of each share (£)': shareholderData.shareValue
          }
        ))
        
        // Contact details
        .addStep(GovUKPatternBlocks.completeFormPage(
          'Your contact details',
          {
            'Email address': contactData.email,
            'Full name': contactData.name
          }
        ))
        
        // Check and submit
        .addCustomStep(async ({ journeyRunner }) => {
          await journeyRunner.verifyHeading('Check your answers');
          await journeyRunner.submit();
          await journeyRunner.verifyHeading('Your application has been submitted');
        })
        .execute();
    });

    test('should complete journey with minimal required fields @journey', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      await new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        
        // Company name (required)
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Minimal Company Ltd' }
        ))
        
        // Address (skip optional fields)
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Main Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        
        // Director (skip optional telephone)
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Director's details",
          {
            'First name': 'Jane',
            'Last name': 'Doe',
            'Email address': 'jane@minimal.com'
          }
        ))
        
        // Shareholder
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Shareholder's details",
          {
            'First name': 'Jane',
            'Last name': 'Doe',
            'Number of shares': '1',
            'Value of each share (£)': '1'
          }
        ))
        
        // Contact
        .addStep(GovUKPatternBlocks.completeFormPage(
          'Your contact details',
          {
            'Email address': 'contact@minimal.com',
            'Full name': 'Jane Doe'
          }
        ))
        
        .addStep(JourneyStepBlocks.checkYourAnswersAndSubmit('Check your answers'))
        .addStep(JourneyStepBlocks.verifyHeading('Your application has been submitted'))
        .execute();
    });
  });

  test.describe('Validation Tests', () => {
    
    test('should validate company name is required @journey @validation', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      await new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(JourneyStepBlocks.verifyHeading("What is the company's proposed name?"))
        
        // Try to continue without entering company name
        .addStep(JourneyStepBlocks.continue())
        
        // Verify error is shown
        .addStep(JourneyStepBlocks.verifyErrorSummary(['Enter a company name']))
        .execute();
    });

    test('should validate registered office address required fields @journey @validation', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      await new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        
        // Fill company name
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Test Company Ltd' }
        ))
        
        // Try to continue without filling address
        .addStep(JourneyStepBlocks.verifyHeading("What is the company's registered office address?"))
        .addStep(JourneyStepBlocks.continue())
        
        // Verify errors for required address fields
        .addStep(JourneyStepBlocks.verifyErrorSummary([
          'Enter address line 1',
          'Enter town or city',
          'Enter postcode'
        ]))
        .execute();
    });

    test('should validate director details required fields @journey @validation', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      const builder = new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Test Company Ltd' }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        .addStep(JourneyStepBlocks.verifyHeading("Director's details"))
        .addStep(JourneyStepBlocks.continue())
        .addStep(JourneyStepBlocks.verifyErrorSummary([
          'Enter first name',
          'Enter last name',
          'Enter email address'
        ]));

      await builder.execute();
    });

    test('should validate email format @journey @validation', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      const builder = new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Test Company Ltd' }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        .addStep(JourneyStepBlocks.verifyHeading("Director's details"))
        
        // Fill with invalid email
        .addCustomStep(async ({ journeyRunner }) => {
          await journeyRunner.fillStep({
            'First name': 'John',
            'Last name': 'Doe',
            'Email address': 'invalid-email'
          });
          await journeyRunner.continue();
        })
        
        .addStep(JourneyStepBlocks.verifyErrorSummary(['Enter a valid email address']));

      await builder.execute();
    });

    test('should validate shareholder share values @journey @validation', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      // Navigate to shareholder page
      const builder = new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Test Company Ltd' }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Director's details",
          {
            'First name': 'John',
            'Last name': 'Doe',
            'Email address': 'john@test.com'
          }
        ))
        .addStep(JourneyStepBlocks.verifyHeading("Shareholder's details"))
        
        // Try to continue without filling shareholder details
        .addStep(JourneyStepBlocks.continue())
        .addStep(JourneyStepBlocks.verifyErrorSummary([
          'Enter first name',
          'Enter last name',
          'Enter number of shares',
          'Enter value of each share'
        ]));

      await builder.execute();
    });
  });

  test.describe('Change Answer Tests', () => {
    
    test('should allow changing company name from check answers @journey', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      // Complete journey to check answers
      const builder = new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Original Company Ltd' }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Director's details",
          {
            'First name': 'John',
            'Last name': 'Doe',
            'Email address': 'john@test.com'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Shareholder's details",
          {
            'First name': 'John',
            'Last name': 'Doe',
            'Number of shares': '100',
            'Value of each share (£)': '1'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          'Your contact details',
          {
            'Email address': 'contact@test.com',
            'Full name': 'John Doe'
          }
        ))
        .addStep(JourneyStepBlocks.verifyCheckYourAnswers('Check your answers'));

      await builder.execute();

      // Change company name
      await componentHelper.clickChangeLink('Company name');
      await journeyRunner.verifyHeading("What is the company's proposed name?");
      await journeyRunner.fillStep({ 'Company name': 'Updated Company Ltd' });
      await journeyRunner.continue();

      // Verify back on check answers with updated value
      await journeyRunner.verifyHeading('Check your answers');
      await componentHelper.verifySummaryRow('Company name', 'Updated Company Ltd');

      // Submit
      await journeyRunner.submit();
      await journeyRunner.verifyHeading('Your application has been submitted');
    });

    test('should allow changing director details from check answers @journey', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      // Navigate to check answers
      const builder = new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Test Company Ltd' }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Director's details",
          {
            'First name': 'John',
            'Last name': 'Doe',
            'Email address': 'john@test.com'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Shareholder's details",
          {
            'First name': 'Jane',
            'Last name': 'Smith',
            'Number of shares': '50',
            'Value of each share (£)': '2'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          'Your contact details',
          {
            'Email address': 'contact@test.com',
            'Full name': 'John Doe'
          }
        ))
        .addStep(JourneyStepBlocks.verifyCheckYourAnswers('Check your answers'));

      await builder.execute();

      // Change director email
      await componentHelper.clickChangeLink('Email address');
      await journeyRunner.verifyHeading("Director's details");
      await journeyRunner.fillStep({ 'Email address': 'updated@test.com' });
      await journeyRunner.continue();

      // Should skip to check answers (not go through all subsequent pages)
      await journeyRunner.verifyHeading('Check your answers');
      await componentHelper.verifySummaryRow('Email address', 'updated@test.com');
    });
  });

  test.describe('Navigation Tests', () => {
    
    test('should allow navigating back through journey @journey', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      const builder = new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Test Company Ltd' }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ));

      await builder.execute();

      // Navigate back
      await journeyRunner.goBack();
      await journeyRunner.verifyHeading("What is the company's proposed name?");

      // Navigate back again
      await journeyRunner.goBack();
      await journeyRunner.verifyHeading('Before you start');

      // Navigate forward again
      await journeyRunner.continue();
      await journeyRunner.verifyHeading("What is the company's proposed name?");
    });
  });

  test.describe('Edge Cases', () => {
    
    test('should handle special characters in company name @journey', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      await new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': "O'Brien & Sons Ltd" }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Director's details",
          {
            'First name': "O'Brien",
            'Last name': 'Smith',
            'Email address': 'test+tag@example.com'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Shareholder's details",
          {
            'First name': "O'Brien",
            'Last name': 'Smith',
            'Number of shares': '1',
            'Value of each share (£)': '1'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          'Your contact details',
          {
            'Email address': 'test+tag@example.com',
            'Full name': "O'Brien Smith"
          }
        ))
        .addStep(JourneyStepBlocks.checkYourAnswersAndSubmit('Check your answers'))
        .addStep(JourneyStepBlocks.verifyHeading('Your application has been submitted'))
        .execute();
    });

    test('should handle same person as director and shareholder @journey', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      const personData = {
        firstName: 'John',
        lastName: 'Smith',
        email: 'john.smith@test.com'
      };

      await new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Single Person Company Ltd' }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's registered office address?",
          {
            'Address line 1': '1 Test Street',
            'Town or city': 'London',
            'Postcode': 'E1 1AA'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Director's details",
          {
            'First name': personData.firstName,
            'Last name': personData.lastName,
            'Email address': personData.email
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          "Shareholder's details",
          {
            'First name': personData.firstName,
            'Last name': personData.lastName,
            'Number of shares': '100',
            'Value of each share (£)': '1'
          }
        ))
        .addStep(GovUKPatternBlocks.completeFormPage(
          'Your contact details',
          {
            'Email address': personData.email,
            'Full name': `${personData.firstName} ${personData.lastName}`
          }
        ))
        .addStep(JourneyStepBlocks.checkYourAnswersAndSubmit('Check your answers'))
        .addStep(JourneyStepBlocks.verifyHeading('Your application has been submitted'))
        .execute();
    });
  });

  test.describe('Accessibility Tests', () => {
    
    test('should verify inset text is accessible @journey @accessibility', async ({ 
      page, 
      journeyRunner,
      componentHelper
    }) => {
      await new JourneyBuilder(page, journeyRunner, componentHelper)
        .addStep(JourneyStepBlocks.startJourney(JOURNEY_PATH))
        .addStep(JourneyStepBlocks.continue())
        .addStep(GovUKPatternBlocks.completeFormPage(
          "What is the company's proposed name?",
          { 'Company name': 'Test Company Ltd' }
        ))
        .addStep(JourneyStepBlocks.verifyHeading("What is the company's registered office address?"))
        
        // Verify inset text is present and accessible
        .addStep(GovUKPatternBlocks.verifyInsetText('The registered office address will appear on the public register'))
        .execute();
    });
  });
});
